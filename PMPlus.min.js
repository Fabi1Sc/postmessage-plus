!function(a,b){"use strict";function c(a){a=a||{},a.listenDomain&&"[object Array]"!==Object.prototype.toString.call(a.listenDomain)&&(a.listenDomain=[a.listenDomain]),this._timeout=a.timeout||3e3,this._listenTimeout=a.listenTimeout||100,this._sendD=a.sendDomain,this._listenD=a.listenDomain||[],this._listeners={},this._rListeners={}}function d(a,b,c){a.postMessage(JSON.stringify(b),c)}function e(a){clearTimeout(a.listenTimeout),clearTimeout(a.timeout)}function f(a){for(var b=0,c=this._listenD.length;c>b;b++)if(a===this._listenD[b]||this._listenD[b]instanceof RegExp&&a.match(this._listenD[b]))return!0;return!1}function g(a){if(this._sendD===a)return!0;for(var b in this._rListeners)for(var c in this._rListeners[b])if(this._rListeners[b][c].domain===a)return!0;return!1}function h(){var a=this;this._eventFn||(this._eventFn=function(b){a._onMessage(b)},window.addEventListener?window.addEventListener("message",this._eventFn):window.attachEvent("onmessage",this._eventFn))}function i(){this._eventFn&&(window.removeEventListener?window.removeEventListener("message",this._eventFn):window.detachEvent("onmessage",this._eventFn),this._eventFn=b)}function j(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;15>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return+new Date+a}c.prototype.send=function(a){var b,c,e={id:j(),channel:a.channel,data:a.data,type:"message"},f=this,g=a.domain||this._sendD;if(!this._sendD&&!a.domain)throw new Error("Must specify domain to send message. Default in Constructor or message specific.");this._rListeners[a.channel]||(this._rListeners[a.channel]={}),d(a.w,e,g),h.call(this),!this._rListeners[a.channel][e.id]&&a.callback&&(b=setTimeout(function(){clearTimeout(c),a.callback(!1,"Timeout"),delete f._rListeners[a.channel][e.id]},this._timeout),c=setTimeout(function(){a.callback(!1,"No listener"),delete f._rListeners[a.channel][e.id]},this._listenTimeout),this._rListeners[a.channel][e.id]={timeout:b,listenTimeout:c,callback:a.callback,domain:g})},c.prototype.listen=function(a,b){if(!this._listenD.length)throw new Error("Not listening to any domains. Specify domains in Constructor.");h.call(this),this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)},c.prototype.destroy=i,c.prototype._onMessage=function(a){var b,c,h,i,j,k,l,m,n=!1,o=f.call(this,a.origin),p=g.call(this,a.origin);if(o||p){try{b=JSON.parse(a.data)}catch(q){return}if("message"===b.type&&o){if(m=function(b,e){n||(n=!0,c.success=b,c.data=e,d(a.source,c,a.origin))},c={id:b.id,channel:b.channel,type:"response",success:!0},!this._listeners[b.channel])return void m(!1,"Invalid Channel: `"+b.channel+"`");for(l=0,j=this._listeners[b.channel].length;j>l;l++)try{this._listeners[b.channel][l](b.data,m),n||(h={id:b.id,channel:b.channel,type:"listening"},d(a.source,h,a.origin))}catch(q){m(!1,"Unknown Error")}}else if(this._rListeners[b.channel]&&this._rListeners[b.channel][b.id]&&this._rListeners[b.channel][b.id].domain===a.origin)if("listening"===b.type)clearTimeout(this._rListeners[b.channel][b.id].listenTimeout);else if("response"===b.type){e(this._rListeners[b.channel][b.id]),this._rListeners[b.channel][b.id].callback(b.success,b.data),delete this._rListeners[b.channel][b.id],k=!1;for(i in this._rListeners[b.channel]){k=!0;break}k||delete this._rListeners[b.channel]}}},a.PMPlus=c}(this,void 0);