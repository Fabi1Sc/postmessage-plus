!function(a,b){"use strict";function c(a){a=a||{},a.listenDomain&&"[object Array]"!==Object.prototype.toString.call(a.listenDomain)&&(a.listenDomain=[a.listenDomain]),this._timeout=a.timeout||3e3,this._sendD=a.sendDomain,this._listenD=a.listenDomain||[],this._listeners={},this._rListeners={}}function d(a,b,c){a.postMessage(JSON.stringify(b),c)}function e(a){for(var b=0,c=this._listenD.length;c>b;b++)if(a===this._listenD[b]||this._listenD[b]instanceof RegExp&&a.match(this._listenD[b]))return!0;return!1}function f(a){if(this._sendD===a)return!0;for(var b in this._rListeners)for(var c in this._rListeners[b])if(this._rListeners[b][c].domain===a)return!0;return!1}function g(){var a=this;this._eventFn||(this._eventFn=function(b){a._onMessage(b)},window.addEventListener?window.addEventListener("message",this._eventFn):window.attachEvent("onmessage",this._eventFn))}function h(){this._eventFn&&(window.removeEventListener?window.removeEventListener("message",this._eventFn):window.detachEvent("onmessage",this._eventFn),this._eventFn=b)}function i(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;15>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return+new Date+a}c.prototype.send=function(a){var b={id:i(),channel:a.channel,data:a.data,type:"message"},c=this,e=a.domain||this._sendD;if(!this._sendD&&!a.domain)throw new Error("Must specify domain to send message. Default in Constructor or message specific.");this._rListeners[a.channel]||(this._rListeners[a.channel]={}),d(a.w,b,e),g.call(this),!this._rListeners[a.channel][b.id]&&a.callback&&(this._rListeners[a.channel][b.id]={timeout:setTimeout(function(){a.callback(!1,"Timeout"),delete c._rListeners[a.channel][b.id]},this._timeout),callback:a.callback,domain:e})},c.prototype.listen=function(a,b){if(!this._listenD.length)throw new Error("Not listening to any domains. Specify domains in Constructor.");g.call(this),this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)},c.prototype.destroy=h,c.prototype._onMessage=function(a){var b,c,g,h,i,j,k,l,m=e.call(this,a.origin),n=f.call(this,a.origin);if(m||n){try{b=JSON.parse(a.data)}catch(o){return}if("message"===b.type&&m){if(k=!1,l=function(b,e){k||(k=!0,c.success=b,c.data=e,d(a.source,c,a.origin))},c={id:b.id,channel:b.channel,type:"response",success:!0},!this._listeners[b.channel])return void l(!1,"Invalid Channel: `"+b.channel+"`");for(j=0,h=this._listeners[b.channel].length;h>j;j++)try{this._listeners[b.channel][j](b.data,l)}catch(o){l(!1,"Unknown Error")}}else if("response"===b.type&&this._rListeners[b.channel]&&this._rListeners[b.channel][b.id]&&this._rListeners[b.channel][b.id].domain===a.origin){clearTimeout(this._rListeners[b.channel][b.id].timeout),this._rListeners[b.channel][b.id].callback(b.success,b.data),delete this._rListeners[b.channel][b.id],i=!1;for(g in this._rListeners[b.channel]){i=!0;break}i||delete this._rListeners[b.channel]}}},a.PMPlus=c}(this,void 0);